<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†æ•°æ®é‡‡é›†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ“š çŸ¥è¯†æ•°æ®é‡‡é›†ç³»ç»Ÿ</h1>
        
        <div class="card">
            <h2>æäº¤æ•°æ®</h2>
            <form id="submitForm">
                <div class="form-group">
                    <label>ä½ çš„å§“å/IDï¼š</label>
                    <input type="text" id="username" required placeholder="è¯·è¾“å…¥ä½ çš„åå­—">
                </div>
                
                <div class="form-group">
                    <label>é€‰æ‹©é¢†åŸŸï¼š</label>
                    <div class="field-row">
                        <select id="fieldSelect" required>
                            <option value="">-- é€‰æ‹©é¢†åŸŸ --</option>
                        </select>
                        <div id="customFieldWrap" class="custom-field-wrap" style="display: none;">
                            <input type="text" id="customField" placeholder="è¾“å…¥æ–°é¢†åŸŸåç§°">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>åŸºæœ¬ä¸–ç•ŒçŸ¥è¯†ï¼š</label>
                    <textarea id="knowledge" required placeholder="ä¾‹å¦‚ï¼šç‰›é¡¿ç¬¬äºŒå®šå¾‹ F=ma"></textarea>
                </div>
                
                <div class="form-group">
                    <label>ç”±æ­¤å¾—åˆ°çš„æ•°æ®ï¼š</label>
                    <textarea id="derivedData" required placeholder="ä¾‹å¦‚ï¼šå½“è´¨é‡ä¸º2kgï¼ŒåŠ é€Ÿåº¦ä¸º3m/sÂ²æ—¶ï¼ŒåŠ›ä¸º6N"></textarea>
                </div>
                
                <button type="submit" class="btn-primary">æäº¤æ•°æ®</button>
            </form>
        </div>
        
        <div class="card">
            <h2>æŸ¥çœ‹æäº¤è®°å½•</h2>
            <div class="search-bar">
                <input type="text" id="searchUser" placeholder="è¾“å…¥ç”¨æˆ·åæŸ¥è¯¢">
                <button type="button" onclick="searchSubmissions()" class="btn-secondary">æŸ¥è¯¢</button>
                <button type="button" onclick="loadAllSubmissions()" class="btn-secondary">æ˜¾ç¤ºå…¨éƒ¨</button>
                <button type="button" onclick="exportAllJson()" class="btn-secondary">å¯¼å‡ºå…¨éƒ¨ JSON</button>
            </div>
            
            <div id="submissionsList"></div>
        </div>
    </div>

    <script>
        // åŠ è½½é¢†åŸŸåˆ—è¡¨
        async function loadFields() {
            try {
                const res = await fetch('/api/fields');
                const data = await res.json();
                
                const select = document.getElementById('fieldSelect');
                select.innerHTML = '<option value="">-- é€‰æ‹©é¢†åŸŸ --</option>';
                
                if (data.fields && Array.isArray(data.fields)) {
                    data.fields.forEach(field => {
                        select.innerHTML += `<option value="${field}">${field}</option>`;
                    });
                    select.innerHTML += '<option value="__new__">â• æ–°å»ºé¢†åŸŸ</option>';
                    console.log('âœ… é¢†åŸŸåŠ è½½æˆåŠŸï¼Œå…±', data.fields.length, 'ä¸ª');
                }
            } catch (error) {
                console.error('âŒ åŠ è½½é¢†åŸŸå¤±è´¥:', error);
                alert('åŠ è½½é¢†åŸŸå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // é¢†åŸŸé€‰æ‹©å˜åŒ–ï¼šæ˜¾ç¤º/éšè—â€œæ–°å»ºé¢†åŸŸâ€è¾“å…¥
        document.getElementById('fieldSelect').addEventListener('change', function () {
            const wrap = document.getElementById('customFieldWrap');
            const customInput = document.getElementById('customField');
            if (this.value === '__new__') {
                wrap.style.display = 'block';
                customInput.required = true;
            } else {
                wrap.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        });

        // æäº¤è¡¨å•
        document.getElementById('submitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            let fieldValue = document.getElementById('fieldSelect').value;
            if (fieldValue === '__new__') {
                fieldValue = document.getElementById('customField').value.trim();
                if (!fieldValue) {
                    alert('è¯·è¾“å…¥æ–°é¢†åŸŸåç§°');
                    return;
                }
            }
            
            const submission = {
                username: document.getElementById('username').value,
                field: fieldValue,
                knowledge: document.getElementById('knowledge').value,
                derivedData: document.getElementById('derivedData').value
            };
            
            try {
                const res = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submission)
                });
                
                if (res.ok) {
                    alert('âœ… æäº¤æˆåŠŸï¼');
                    document.getElementById('submitForm').reset();
                    document.getElementById('customFieldWrap').style.display = 'none';
                    loadFields(); // æ¢å¤ä¸‹æ‹‰é€‰é¡¹
                    loadAllSubmissions();
                } else {
                    const error = await res.json();
                    alert('âŒ æäº¤å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                alert('âŒ æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        });

        // åŠ è½½æ‰€æœ‰æäº¤
        async function loadAllSubmissions() {
            try {
                const res = await fetch('/api/submissions');
                const data = await res.json();
                displaySubmissions(data.submissions || []);
            } catch (error) {
                console.error('åŠ è½½æäº¤å¤±è´¥:', error);
                document.getElementById('submissionsList').innerHTML = 
                    '<p class="no-data">âš ï¸ åŠ è½½å¤±è´¥</p>';
            }
        }

        // å¯¼å‡ºå…¨éƒ¨æ•°æ®ä¸º JSON æ–‡ä»¶ï¼ˆæ–¹ä¾¿åå°ä¿å­˜ï¼‰
        async function exportAllJson() {
            try {
                const res = await fetch('/api/submissions');
                const data = await res.json();
                const blob = new Blob([JSON.stringify(data.submissions || [], null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'submissions_' + new Date().toISOString().slice(0, 10) + '.json';
                a.click();
                URL.revokeObjectURL(a.href);
            } catch (e) {
                console.error(e);
                alert('å¯¼å‡ºå¤±è´¥');
            }
        }

        // æœç´¢ç”¨æˆ·æäº¤
        async function searchSubmissions() {
            const username = document.getElementById('searchUser').value.trim();
            
            if (!username) {
                loadAllSubmissions();
                return;
            }
            
            try {
                const res = await fetch(`/api/submissions?username=${encodeURIComponent(username)}`);
                const data = await res.json();
                displaySubmissions(data.submissions || []);
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæäº¤åˆ—è¡¨
        function displaySubmissions(submissions) {
            const list = document.getElementById('submissionsList');
            
            if (!submissions || submissions.length === 0) {
                list.innerHTML = '<p class="no-data">æš‚æ— æ•°æ®</p>';
                return;
            }
            
            list.innerHTML = submissions.map(s => `
                <div class="submission-item">
                    <div class="submission-header">
                        <span class="username">ğŸ‘¤ ${s.username}</span>
                        <span class="field-tag">${s.field}</span>
                        <span class="timestamp">${new Date(s.timestamp).toLocaleString('zh-CN')}</span>
                    </div>
                    <div class="submission-content">
                        <p><strong>ä¸–ç•ŒçŸ¥è¯†ï¼š</strong>${s.knowledge}</p>
                        <p><strong>å¾—åˆ°çš„æ•°æ®ï¼š</strong>${s.derivedData}</p>
                    </div>
                    <button type="button" class="btn-delete" data-id="${s.id}" onclick="deleteSubmission(this.dataset.id)">åˆ é™¤</button>
                </div>
            `).join('');
        }

        // åˆ é™¤æäº¤
        async function deleteSubmission(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`/api/submissions?id=${id}`, { 
                    method: 'DELETE' 
                });
                
                if (res.ok) {
                    alert('âœ… åˆ é™¤æˆåŠŸ');
                    loadAllSubmissions();
                } else {
                    alert('âŒ åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('âŒ åˆ é™¤å¤±è´¥');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            loadFields();
            loadAllSubmissions();
        });
    </script>
</body>
</html>
