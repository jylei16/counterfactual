<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†æ•°æ®é‡‡é›†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ“š çŸ¥è¯†æ•°æ®é‡‡é›†ç³»ç»Ÿ</h1>
        
        <!-- æäº¤è¡¨å• -->
        <div class="card">
            <h2>æäº¤æ•°æ®</h2>
            <form id="submitForm">
                <div class="form-group">
                    <label>ä½ çš„å§“å/IDï¼š</label>
                    <input type="text" id="username" required placeholder="è¯·è¾“å…¥ä½ çš„åå­—">
                </div>
                
                <div class="form-group">
                    <label>é€‰æ‹©é¢†åŸŸï¼š</label>
                    <div class="field-selector">
                        <select id="fieldSelect" required>
                            <option value="">-- é€‰æ‹©é¢†åŸŸ --</option>
                        </select>
                        <button type="button" id="addFieldBtn">+ æ–°å»ºé¢†åŸŸ</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>åŸºæœ¬ä¸–ç•ŒçŸ¥è¯†ï¼š</label>
                    <textarea id="knowledge" required placeholder="ä¾‹å¦‚ï¼šç‰›é¡¿ç¬¬äºŒå®šå¾‹ F=ma"></textarea>
                </div>
                
                <div class="form-group">
                    <label>ç”±æ­¤å¾—åˆ°çš„æ•°æ®ï¼š</label>
                    <textarea id="derivedData" required placeholder="ä¾‹å¦‚ï¼šå½“è´¨é‡ä¸º2kgï¼ŒåŠ é€Ÿåº¦ä¸º3m/sÂ²æ—¶ï¼ŒåŠ›ä¸º6N"></textarea>
                </div>
                
                <button type="submit" class="btn-primary">æäº¤æ•°æ®</button>
            </form>
        </div>
        
        <!-- æ•°æ®æŸ¥çœ‹ -->
        <div class="card">
            <h2>æŸ¥çœ‹æäº¤è®°å½•</h2>
            <div class="search-bar">
                <input type="text" id="searchUser" placeholder="è¾“å…¥ç”¨æˆ·åæŸ¥è¯¢">
                <button onclick="searchSubmissions()" class="btn-secondary">æŸ¥è¯¢</button>
                <button onclick="loadAllSubmissions()" class="btn-secondary">æ˜¾ç¤ºå…¨éƒ¨</button>
            </div>
            
            <div id="submissionsList"></div>
        </div>
    </div>

    <script>
        // åŠ è½½é¢†åŸŸåˆ—è¡¨
        async function loadFields() {
            const res = await fetch('/api/fields');
            const data = await res.json();
            const select = document.getElementById('fieldSelect');
            select.innerHTML = '<option value="">-- é€‰æ‹©é¢†åŸŸ --</option>';
            data.fields.forEach(field => {
                select.innerHTML += `<option value="${field}">${field}</option>`;
            });
        }

        // æ·»åŠ æ–°é¢†åŸŸ
        document.getElementById('addFieldBtn').addEventListener('click', async () => {
            const field = prompt('è¯·è¾“å…¥æ–°é¢†åŸŸåç§°ï¼š');
            if (field) {
                await fetch('/api/fields', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ field })
                });
                loadFields();
            }
        });

        // æäº¤è¡¨å•
        document.getElementById('submitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submission = {
                username: document.getElementById('username').value,
                field: document.getElementById('fieldSelect').value,
                knowledge: document.getElementById('knowledge').value,
                derivedData: document.getElementById('derivedData').value
            };
            
            const res = await fetch('/api/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(submission)
            });
            
            if (res.ok) {
                alert('æäº¤æˆåŠŸï¼');
                e.target.reset();
                loadAllSubmissions();
            } else {
                alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        // åŠ è½½æ‰€æœ‰æäº¤
        async function loadAllSubmissions() {
            const res = await fetch('/api/submissions');
            const data = await res.json();
            displaySubmissions(data.submissions);
        }

        // æœç´¢ç”¨æˆ·æäº¤
        async function searchSubmissions() {
            const username = document.getElementById('searchUser').value;
            if (!username) {
                loadAllSubmissions();
                return;
            }
            
            const res = await fetch(`/api/submissions/${username}`);
            const data = await res.json();
            displaySubmissions(data.submissions);
        }

        // æ˜¾ç¤ºæäº¤åˆ—è¡¨
        function displaySubmissions(submissions) {
            const list = document.getElementById('submissionsList');
            
            if (submissions.length === 0) {
                list.innerHTML = '<p class="no-data">æš‚æ— æ•°æ®</p>';
                return;
            }
            
            list.innerHTML = submissions.map(s => `
                <div class="submission-item">
                    <div class="submission-header">
                        <span class="username">ğŸ‘¤ ${s.username}</span>
                        <span class="field-tag">${s.field}</span>
                        <span class="timestamp">${new Date(s.timestamp).toLocaleString('zh-CN')}</span>
                    </div>
                    <div class="submission-content">
                        <p><strong>ä¸–ç•ŒçŸ¥è¯†ï¼š</strong>${s.knowledge}</p>
                        <p><strong>å¾—åˆ°çš„æ•°æ®ï¼š</strong>${s.derivedData}</p>
                    </div>
                    <button onclick="deleteSubmission('${s.id}')" class="btn-delete">åˆ é™¤</button>
                </div>
            `).join('');
        }

        // åˆ é™¤æäº¤
        async function deleteSubmission(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
            
            await fetch(`/api/submissions/${id}`, { method: 'DELETE' });
            loadAllSubmissions();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        loadFields();
        loadAllSubmissions();
    </script>
</body>
</html>
